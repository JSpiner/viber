<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Viber</title>
  <link rel="stylesheet" href="styles.css">
  <link rel="stylesheet" href="hooks.css">
  <link rel="stylesheet" href="agents.css">
  <link rel="stylesheet" href="sessionLog.css">
</head>
<body>
  <div class="app-container">
    <nav class="sidebar">
      <div class="sidebar-header">
        <img src="resources/icon.png" alt="Viber Logo" class="app-logo">
        <h1 class="app-title">Viber</h1>
      </div>
      
      <div class="nav-items">
        <button class="nav-item active" data-tab="now">
          <svg class="nav-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="10"></circle>
            <polyline points="12 6 12 12 16 14"></polyline>
          </svg>
          <span class="nav-label">Now</span>
        </button>
        
        <button class="nav-item" data-tab="statistics">
          <svg class="nav-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="18" y1="20" x2="18" y2="10"></line>
            <line x1="12" y1="20" x2="12" y2="4"></line>
            <line x1="6" y1="20" x2="6" y2="14"></line>
          </svg>
          <span class="nav-label">Statistics</span>
        </button>
        
        <button class="nav-item" data-tab="session-log">
          <svg class="nav-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
            <polyline points="14 2 14 8 20 8"></polyline>
            <line x1="16" y1="13" x2="8" y2="13"></line>
            <line x1="16" y1="17" x2="8" y2="17"></line>
            <polyline points="10 9 9 9 8 9"></polyline>
          </svg>
          <span class="nav-label">Session Log</span>
        </button>
        
        <button class="nav-item" data-tab="agents">
          <svg class="nav-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
            <circle cx="12" cy="7" r="4"></circle>
          </svg>
          <span class="nav-label">Agents</span>
        </button>
        
        <button class="nav-item" data-tab="hooks">
          <svg class="nav-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
            <polyline points="22 4 12 14.01 9 11.01"></polyline>
          </svg>
          <span class="nav-label">Hooks</span>
        </button>
        
        <button class="nav-item" data-tab="settings">
          <svg class="nav-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <circle cx="12" cy="12" r="3"></circle>
            <path d="M12 1v6m0 6v6m4.22-10.22l4.24 4.24m-4.24 4.24l4.24 4.24M20 12h-6m-6 0H2m10.22-4.22L7.98 3.54m4.24 4.24L7.98 20.46"></path>
          </svg>
          <span class="nav-label">Settings</span>
        </button>
      </div>
    </nav>
    
    <main class="main-content">
      <div id="now" class="content-panel active">
        <div class="panel-header">
          <h2>Now</h2>
          <div class="now-controls">
            <select id="subscriptionTier" class="tier-selector">
              <option value="pro">Pro ($20/month)</option>
              <option value="max5x">Max 5x ($100/month)</option>
              <option value="max20x">Max 20x ($200/month)</option>
            </select>
          </div>
        </div>
        <div class="panel-body">
          <div class="now-container">
            <!-- Recent Usage Section -->
            <div class="usage-card recent-usage">
              <h3>Recent Usage (10 minutes)</h3>
              <div class="usage-metrics">
                <div class="metric">
                  <div class="metric-label">Total Tokens</div>
                  <div class="metric-value" id="recentTokens">0</div>
                </div>
                <div class="metric">
                  <div class="metric-label">Rate</div>
                  <div class="metric-value">
                    <span id="tokensPerMinute">0 tpm</span>
                    <span class="trend-indicator" id="usageTrend">â†’</span>
                  </div>
                </div>
              </div>
            </div>

            <!-- 5-Hour Window Section -->
            <div class="usage-card five-hour-window">
              <h3>Token Limit: 5 hour window</h3>
              <div class="window-content">
                <div class="usage-stats">
                  <div class="stat-row highlight-remaining">
                    <span class="stat-label">Remaining</span>
                    <span class="stat-value" id="fiveHourRemaining">0</span>
                  </div>
                  <div class="stat-row">
                    <span class="stat-label">Session Started</span>
                    <span class="stat-value" id="fiveHourSessionStart">--</span>
                  </div>
                  <div class="stat-row">
                    <span class="stat-label">Effective Used</span>
                    <span class="stat-value" id="fiveHourUsed">0</span>
                  </div>
                  <div class="stat-row">
                    <span class="stat-label">Limit</span>
                    <span class="stat-value" id="fiveHourLimit">0</span>
                  </div>
                  <div class="stat-row cache-savings">
                    <span class="stat-label">Cache Savings</span>
                    <span class="stat-value" id="fiveHourCacheSavings">0</span>
                  </div>
                </div>
                <div class="progress-container">
                  <div class="progress-bar-wrapper">
                    <div class="progress-bar safe" id="fiveHourProgress"></div>
                  </div>
                  <div class="progress-info">
                    <span id="fiveHourPercentage">0%</span>
                    <span class="reset-time">Reset in <span id="fiveHourReset">--</span></span>
                  </div>
                </div>
                <div class="chart-container small">
                  <canvas id="fiveHourChart"></canvas>
                </div>
              </div>
            </div>

            <!-- Weekly Window Section -->
            <div class="usage-card weekly-window">
              <h3>Token Limit: weekly window</h3>
              <div class="window-content">
                <div class="usage-stats">
                  <div class="stat-row highlight-remaining">
                    <span class="stat-label">Remaining</span>
                    <span class="stat-value" id="weeklyRemaining">0</span>
                  </div>
                  <div class="stat-row">
                    <span class="stat-label">Session Started</span>
                    <span class="stat-value" id="weeklySessionStart">--</span>
                  </div>
                  <div class="stat-row">
                    <span class="stat-label">Effective Used</span>
                    <span class="stat-value" id="weeklyUsed">0</span>
                  </div>
                  <div class="stat-row">
                    <span class="stat-label">Limit</span>
                    <span class="stat-value" id="weeklyLimit">0</span>
                  </div>
                  <div class="stat-row cache-savings">
                    <span class="stat-label">Cache Savings</span>
                    <span class="stat-value" id="weeklyCacheSavings">0</span>
                  </div>
                </div>
                <div class="progress-container">
                  <div class="progress-bar-wrapper">
                    <div class="progress-bar safe" id="weeklyProgress"></div>
                  </div>
                  <div class="progress-info">
                    <span id="weeklyPercentage">0%</span>
                    <span class="reset-time">Reset in <span id="weeklyReset">--</span></span>
                  </div>
                </div>
                <div class="chart-container medium">
                  <canvas id="weeklyChart"></canvas>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <div id="statistics" class="content-panel">
        <div class="panel-header">
          <h2>Statistics</h2>
          <div class="stats-controls">
            <div class="view-toggle">
              <button class="toggle-btn active" data-view="daily">Daily Usage</button>
              <button class="toggle-btn" data-view="session">Session Usage</button>
            </div>
            <div class="date-range">
              <input type="date" id="startDate" class="date-input">
              <span class="date-separator">to</span>
              <input type="date" id="endDate" class="date-input">
            </div>
          </div>
        </div>
        <div class="panel-body">
          <div class="stats-container">
            <!-- Summary Cards -->
            <div class="summary-cards">
              <div class="summary-card">
                <div class="card-label">Total Tokens</div>
                <div class="card-value" id="totalTokens">0</div>
              </div>
              <div class="summary-card">
                <div class="card-label">Total Cost</div>
                <div class="card-value" id="totalCost">$0.00</div>
              </div>
              <div class="summary-card">
                <div class="card-label">Most Used Model</div>
                <div class="card-value" id="mostUsedModel">-</div>
              </div>
            </div>

            <!-- Daily View -->
            <div id="dailyView" class="view-content active">
              <div class="chart-container">
                <canvas id="dailyChart"></canvas>
              </div>
              <div class="daily-details" id="dailyDetails"></div>
            </div>

            <!-- Session View -->
            <div id="sessionView" class="view-content">
              <div class="session-timeline-container">
                <h3>Session Timeline</h3>
                <div class="timeline-chart-container">
                  <canvas id="timelineChart"></canvas>
                </div>
              </div>
              <div class="session-list" id="sessionList"></div>
            </div>
          </div>
        </div>
      </div>
      
      <div id="session-log" class="content-panel">
        <div class="panel-body" style="padding: 0; height: 100%;">
          <div class="session-log-container">
            <!-- Left Panel: Sessions List -->
            <div class="sessions-panel">
              <div class="sessions-header">
                <h3>Sessions</h3>
                <div class="session-controls">
                  <input type="text" id="session-search" class="session-search" placeholder="Search sessions...">
                  <select id="session-sort" class="session-sort">
                    <option value="recent">Most Recent</option>
                    <option value="oldest">Oldest First</option>
                    <option value="size">Largest Size</option>
                  </select>
                </div>
              </div>
              <div id="sessions-list"></div>
            </div>

            <!-- Center Panel: Message Timeline -->
            <div class="messages-panel">
              <div class="messages-header">
                <div id="session-title">Select a session to view messages</div>
              </div>
              <div id="message-timeline">
                <div class="empty-state">
                  <svg width="48" height="48" viewBox="0 0 48 48" fill="none" opacity="0.5">
                    <rect x="8" y="8" width="32" height="32" rx="4" stroke="currentColor" stroke-width="2"/>
                    <path d="M16 20h16M16 28h10" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                  </svg>
                  <p>Select a session to view messages</p>
                </div>
              </div>
            </div>

            <!-- Right Panel: Message Detail -->
            <div class="detail-panel">
              <div class="detail-header">
                <h3>Message Details</h3>
                <div class="message-meta">
                  <div class="meta-row">
                    <span class="meta-label">Type:</span>
                    <span class="meta-value" id="message-type">-</span>
                  </div>
                  <div class="meta-row">
                    <span class="meta-label">Time:</span>
                    <span class="meta-value" id="message-time">-</span>
                  </div>
                  <div class="meta-row">
                    <span class="meta-label">Tokens:</span>
                    <span class="meta-value" id="message-tokens">-</span>
                  </div>
                </div>
              </div>
              <div id="message-detail">
                <div class="empty-state">
                  <svg width="48" height="48" viewBox="0 0 48 48" fill="none" opacity="0.5">
                    <path d="M24 12v16M24 32h.01" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"/>
                    <circle cx="24" cy="24" r="20" stroke="currentColor" stroke-width="2"/>
                  </svg>
                  <p>Select a message to view details</p>
                </div>
                <div id="message-content" style="display: none;"></div>
              </div>
            </div>
          </div>

          <!-- Code Diff Viewer Modal -->
          <div id="code-diff-viewer">
            <div class="diff-header">
              <h3>Code Changes</h3>
              <div class="diff-controls">
                <button id="diff-view-toggle" class="diff-control-btn">Toggle View</button>
                <button onclick="document.getElementById('code-diff-viewer').style.display='none'" class="diff-control-btn">Close</button>
              </div>
            </div>
            <div id="diff-content"></div>
          </div>
        </div>
      </div>
      
      <div id="agents" class="content-panel">
        <div class="panel-body" style="padding: 0; height: 100%;">
          <div class="agents-container">
            <!-- Left Panel: Agents List -->
            <div class="agents-list-panel">
              <div class="agents-header">
                <h2>Agents</h2>
                <button id="agents-new-agent-btn" class="primary-btn">
                  <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
                    <path d="M8 3v10M3 8h10" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                  </svg>
                  New Agent
                </button>
              </div>

              <div class="search-container">
                <input type="text" id="agents-agent-search" placeholder="Search agents..." class="search-input">
              </div>

              <div class="agents-sections">
                <!-- My Agents Section -->
                <div class="agents-section">
                  <div class="section-header">
                    <svg class="section-icon" width="16" height="16" viewBox="0 0 16 16" fill="none">
                      <path d="M4 2v12M12 2v12M2 8h12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                    </svg>
                    <span>My Agents</span>
                    <span class="agent-count" id="agents-my-agents-count">0</span>
                  </div>
                  <div id="agents-my-agents-list" class="agents-list"></div>
                </div>

                <!-- Recommended Agents Section -->
                <div class="agents-section">
                  <div class="section-header">
                    <svg class="section-icon" width="16" height="16" viewBox="0 0 16 16" fill="none">
                      <path d="M8 2l2.2 4.6L15 7.3l-3.5 3.6.8 5.1L8 13.7 3.7 16l.8-5.1L1 7.3l4.8-.7L8 2z" stroke="currentColor" stroke-width="2" stroke-linejoin="round"/>
                    </svg>
                    <span>Recommended</span>
                    <span class="agent-count" id="agents-recommended-agents-count">0</span>
                  </div>
                  <div id="agents-recommended-agents-list" class="agents-list"></div>
                </div>
              </div>
            </div>

            <!-- Right Panel: Agent Detail/Editor -->
            <div class="agent-detail-panel">
              <div id="agents-empty-state" class="empty-state">
                <svg width="48" height="48" viewBox="0 0 48 48" fill="none" opacity="0.5">
                  <rect x="8" y="8" width="32" height="32" rx="4" stroke="currentColor" stroke-width="2"/>
                  <path d="M16 20h16M16 28h10" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                </svg>
                <p>Select an agent to view details</p>
              </div>

              <div id="agents-agent-detail" class="agent-detail" style="display: none;">
                <div class="agent-detail-header">
                  <input type="text" id="agents-agent-name" class="agent-name-input" placeholder="Agent Name">
                  <div class="agent-actions">
                    <button id="agents-clone-btn" class="icon-btn" title="Clone Agent">
                      <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
                        <rect x="2" y="2" width="8" height="8" stroke="currentColor" stroke-width="2"/>
                        <rect x="6" y="6" width="8" height="8" stroke="currentColor" stroke-width="2" fill="var(--bg-secondary)"/>
                      </svg>
                    </button>
                    <button id="agents-delete-btn" class="icon-btn danger" title="Delete Agent">
                      <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
                        <path d="M6 2h4M2 4h12M13 4v9a1 1 0 01-1 1H4a1 1 0 01-1-1V4M7 7v4M9 7v4" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                      </svg>
                    </button>
                  </div>
                </div>

                <div class="agent-meta">
                  <span id="agents-agent-source" class="agent-source"></span>
                  <span id="agents-agent-modified" class="agent-modified"></span>
                </div>

                <div class="form-group">
                  <label for="agent-content">Agent Configuration (Markdown)</label>
                  <textarea id="agents-agent-content" class="form-textarea code" rows="20" placeholder="Define your agent using markdown format with YAML frontmatter"></textarea>
                </div>

                <div class="agent-actions-footer">
                  <button id="agents-cancel-btn" class="secondary-btn">Cancel</button>
                  <button id="agents-save-btn" class="primary-btn">Save</button>
                </div>
              </div>

              <!-- Agent Preview for Recommended Agents -->
              <div id="agents-agent-preview" class="agent-preview" style="display: none;">
                <div class="agent-preview-header">
                  <h2 id="agents-preview-name"></h2>
                  <button id="agents-install-btn" class="primary-btn">
                    <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
                      <path d="M8 2v8M4 6l4 4 4-4M2 14h12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                    Install Agent
                  </button>
                </div>

                <div class="agent-meta">
                  <span id="agents-preview-source" class="agent-source">Source: wshobson/agents</span>
                  <span id="agents-preview-category" class="agent-category"></span>
                </div>

                <div class="preview-section">
                  <h3>Description</h3>
                  <p id="agents-preview-description"></p>
                </div>

                <div class="preview-section">
                  <h3>System Prompt</h3>
                  <pre id="agents-preview-prompt" class="code-block"></pre>
                </div>

                <div class="preview-section">
                  <h3>Tools</h3>
                  <div id="agents-preview-tools" class="tools-list readonly"></div>
                </div>

                <div class="preview-section">
                  <h3>Model</h3>
                  <p id="agents-preview-model"></p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <div id="hooks" class="content-panel">
        <div class="panel-header">
          <h2>Hooks</h2>
          <div class="hooks-controls">
            <button id="viewInstalledHooks" class="btn-secondary">View Installed</button>
            <button id="viewRawJson" class="btn-secondary">Raw JSON</button>
            <button id="refreshHooks" class="btn-secondary">Refresh</button>
          </div>
        </div>
        <div class="panel-body">
          <div class="hooks-container">
            <!-- Installed Hooks Section -->
            <div class="hooks-section" id="installedHooksSection">
              <h3>Installed Hooks <span id="installedHooksCount">(0)</span></h3>
              <div id="installedHooksList" class="hooks-list">
                <!-- Installed hooks will be dynamically added here -->
              </div>
            </div>

            <!-- Available Hooks Section -->
            <div class="hooks-section" id="availableHooksSection">
              <h3>Available Hooks</h3>
              <div id="availableHooksList" class="hooks-list">
                <!-- Available hooks will be dynamically added here -->
              </div>
            </div>

            <!-- Raw JSON View (Hidden by default) -->
            <div class="raw-json-view" id="rawJsonView" style="display: none;">
              <h3>settings.json - Hooks Section</h3>
              <pre id="rawJsonContent"></pre>
              <div class="json-actions">
                <button id="copyJsonBtn" class="btn-primary">Copy to Clipboard</button>
                <button id="closeJsonView" class="btn-secondary">Close</button>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <div id="settings" class="content-panel">
        <div class="panel-header">
          <h2>Settings</h2>
        </div>
        <div class="panel-body">
          <div class="settings-container">
            <!-- Status Bar Settings -->
            <div class="settings-section">
              <h3>Status Bar</h3>
              <div class="settings-group">
                <div class="setting-item">
                  <label class="setting-label">
                    <input type="checkbox" id="statusBarEnabled" class="setting-checkbox">
                    <span>Show in status bar</span>
                  </label>
                  <p class="setting-description">Display token usage monitor in macOS menu bar</p>
                </div>
                
                <div class="setting-item">
                  <label class="setting-label" for="displayMode">Display mode</label>
                  <select id="displayMode" class="setting-select status-bar-setting">
                    <option value="full">Full (Icon, Tokens/min, %, Session)</option>
                    <option value="compact">Compact (Icon, Tokens/min)</option>
                    <option value="icon-only">Icon only</option>
                  </select>
                  <p class="setting-description">Choose what to display in the status bar</p>
                </div>
                
                <div class="setting-item">
                  <label class="setting-label" for="updateFrequency">Update frequency</label>
                  <div class="slider-container">
                    <input type="range" id="updateFrequency" class="setting-slider status-bar-setting" 
                           min="1" max="60" value="5" step="1">
                    <span class="slider-value" id="updateFrequencyValue">5 min</span>
                  </div>
                  <p class="setting-description">How often to refresh usage data</p>
                </div>
              </div>
            </div>
            
            <!-- Alert Settings -->
            <div class="settings-section">
              <h3>Alerts</h3>
              <div class="settings-group">
                <div class="setting-item">
                  <label class="setting-label">
                    <input type="checkbox" id="alertsEnabled" class="setting-checkbox status-bar-setting">
                    <span>Enable usage alerts</span>
                  </label>
                  <p class="setting-description">Show notifications when approaching token limits</p>
                </div>
                
                <div class="setting-item">
                  <label class="setting-label" for="alertThreshold">Alert threshold</label>
                  <div class="slider-container">
                    <input type="range" id="alertThreshold" class="setting-slider status-bar-setting" 
                           min="50" max="99" value="90" step="1">
                    <span class="slider-value" id="alertThresholdValue">90%</span>
                  </div>
                  <p class="setting-description">Show alert when usage exceeds this percentage</p>
                </div>
                
                <div class="setting-item">
                  <label class="setting-label">
                    <input type="checkbox" id="notifyOnReset" class="setting-checkbox status-bar-setting">
                    <span>Notify on window reset</span>
                  </label>
                  <p class="setting-description">Show notification when 5-hour window resets</p>
                </div>
              </div>
            </div>
            
            <!-- Save Button -->
            <div class="settings-actions">
              <button id="saveSettings" class="save-button">Save Settings</button>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>
  
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/date-fns@2.29.3/index.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
  <script src="renderer.js"></script>
  <script src="statistics.js"></script>
  <script src="now.js"></script>
  <script src="settings.js"></script>
  <script src="hooks.js"></script>
  <script src="agents.js"></script>
  <script src="sessionLog.js"></script>
</body>
</html>